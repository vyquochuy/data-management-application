-- Kết nối với SYS
--CONNECT SYS/123@localhost:1521/ORCL AS SYSDBA;

CREATE PLUGGABLE DATABASE QLCSDL
ADMIN USER admin IDENTIFIED BY 123
ROLES = (DBA)
FILE_NAME_CONVERT = ('pdbseed', 'QLCSDL');
SELECT name, open_mode FROM v$pdbs;

-- Mở PDB
ALTER PLUGGABLE DATABASE QLCSDL OPEN;

-- Kiểm tra PDB
-- SELECT name, con_id, open_mode FROM v$pdbs;
-- Chuyển sang PDB
ALTER SESSION SET CONTAINER = QLCSDL;

-- Tạo user
CREATE USER school_user IDENTIFIED BY 123;
GRANT CONNECT, RESOURCE, CREATE SESSION, CREATE TABLE TO school_user;
GRANT UNLIMITED TABLESPACE TO school_user;
GRANT CREATE VIEW TO school_user;
GRANT CREATE ROLE TO school_user;

-- Kết nối với user
CONNECT school_user/123@localhost:1521/QLCSDL;
-- SHOW CON_NAME;
-- SELECT username, 'OPEN' AS account_status FROM all_users
-- Xóa bảng con trước
-- DROP TABLE DANGKY CASCADE CONSTRAINTS;
-- DROP TABLE MOMON CASCADE CONSTRAINTS;
-- DROP TABLE HOCPHAN CASCADE CONSTRAINTS;
-- DROP TABLE SINHVIEN CASCADE CONSTRAINTS;
-- DROP TABLE NHANVIEN CASCADE CONSTRAINTS;
-- Cuối cùng xóa bảng DONVI
-- DROP TABLE DONVI CASCADE CONSTRAINTS;
-- Tạo bảng DONVI trước (chưa có khóa ngoại TRGDV)
CREATE TABLE DONVI (
    MADV VARCHAR2(10) PRIMARY KEY,
    TENDV VARCHAR2(100) NOT NULL,
    LOAIDV VARCHAR2(10) NOT NULL CHECK (LOAIDV IN ('Khoa', 'Phòng')),
    TRGDV VARCHAR2(10)
);

-- Tạo bảng NHANVIEN với khóa ngoại MADV tham chiếu đến DONVI
CREATE TABLE NHANVIEN (
    MANV VARCHAR2(10) PRIMARY KEY,
    HOTEN VARCHAR2(100) NOT NULL,
    PHAI VARCHAR2(4) CHECK (PHAI IN ('Nam', 'Nữ')),
    NGSINH DATE,
    LUONG NUMBER,
    PHUCAP NUMBER,
    DT VARCHAR2(15),
    VAITRO VARCHAR2(20) CHECK (VAITRO IN ('NVCB', 'GV', 'NV PĐT', 'NV PKT', 'NV TCHC', 'NV CTSV', 'TRGDV')),
    MADV VARCHAR2(10) NOT NULL,
    CONSTRAINT fk_nv_dv FOREIGN KEY (MADV) REFERENCES DONVI(MADV)
);

-- Thêm khóa ngoại TRGDV cho DONVI tham chiếu đến NHANVIEN
ALTER TABLE DONVI
ADD CONSTRAINT fk_dv_trg FOREIGN KEY (TRGDV) REFERENCES NHANVIEN(MANV);

-- Tạo bảng SINHVIEN
CREATE TABLE SINHVIEN (
    MASV VARCHAR2(10) PRIMARY KEY,
    HOTEN VARCHAR2(100) NOT NULL,
    PHAI VARCHAR2(4) CHECK (PHAI IN ('Nam', 'Nữ')),
    NGSINH DATE,
    DCHI VARCHAR2(200),
    DT VARCHAR2(15),
    KHOA VARCHAR2(10) NOT NULL,
    TINHTRANG VARCHAR2(20) CHECK (TINHTRANG IN ('đang học', 'nghỉ học', 'bảo lưu')),
    CONSTRAINT fk_sv_khoa FOREIGN KEY (KHOA) REFERENCES DONVI(MADV)
);

-- Tạo bảng HOCPHAN
CREATE TABLE HOCPHAN (
    MAHP VARCHAR2(10) PRIMARY KEY,
    TENHP VARCHAR2(100) NOT NULL,
    SOTC NUMBER,
    STLT NUMBER,
    STTH NUMBER,
    MADV VARCHAR2(10) NOT NULL,
    CONSTRAINT fk_hp_dv FOREIGN KEY (MADV) REFERENCES DONVI(MADV)
);

-- Tạo bảng MOMON
CREATE TABLE MOMON (
    MAMM VARCHAR2(10) PRIMARY KEY,
    MAHP VARCHAR2(10) NOT NULL,
    MAGV VARCHAR2(10) NOT NULL,
    HK NUMBER(1) CHECK (HK IN (1, 2, 3)),
    NAM NUMBER(4),
    CONSTRAINT fk_mm_hp FOREIGN KEY (MAHP) REFERENCES HOCPHAN(MAHP),
    CONSTRAINT fk_mm_gv FOREIGN KEY (MAGV) REFERENCES NHANVIEN(MANV)
);

-- Tạo bảng DANGKY
CREATE TABLE DANGKY (
    MASV VARCHAR2(10),
    MAMM VARCHAR2(10),
    DIEMTH NUMBER(5,2) CHECK (DIEMTH BETWEEN 0 AND 10),
    DIEMQT NUMBER(5,2) CHECK (DIEMQT BETWEEN 0 AND 10),
    DIEMCK NUMBER(5,2) CHECK (DIEMCK BETWEEN 0 AND 10),
    DIEMTK NUMBER(5,2) CHECK (DIEMTK BETWEEN 0 AND 10),
    PRIMARY KEY (MASV, MAMM),
    CONSTRAINT fk_dk_sv FOREIGN KEY (MASV) REFERENCES SINHVIEN(MASV),
    CONSTRAINT fk_dk_mm FOREIGN KEY (MAMM) REFERENCES MOMON(MAMM)
);

-- Tạo bảng THONGBAO
CREATE TABLE THONGBAO (
    ID NUMBER PRIMARY KEY,
    NOIDUNG VARCHAR2(1000),
    LABEL_COLUMN NUMBER
);

CONNECT school_user/123@localhost:1521/QLCSDL;
-- Tắt tự động commit để có thể rollback nếu có lỗi
SET AUTOCOMMIT OFF;

-- 1. Chèn dữ liệu vào bảng DONVI (Phải thực hiện đầu tiên)
INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV) VALUES ('HOA', 'Khoa Hóa học', 'Khoa', NULL);
INSERT INTO DONVI (MADV, TENDV, LOAIDV, TRGDV) VALUES ('PĐT', 'Phòng Đào tạo', 'Phòng', NULL);
COMMIT;

-- 2. Chèn dữ liệu vào bảng NHANVIEN (Thêm trưởng đơn vị trước)
-- Nhân viên là Trưởng khoa Hóa học
INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV) 
VALUES ('NV001', 'Nguyễn Văn A', 'Nam', TO_DATE('1980-01-15', 'YYYY-MM-DD'), 20000000, 5000000, '0912345678', 'TRGDV', 'HOA');

-- Nhân viên Phòng Đào tạo
INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV) 
VALUES ('NV002', 'Trần Thị B', 'Nữ', TO_DATE('1990-05-20', 'YYYY-MM-DD'), 15000000, 3000000, '0987654321', 'NV PĐT', 'PĐT');

-- Giảng viên Khoa Hóa học
INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV) 
VALUES ('GV001', 'Lê Văn C', 'Nam', TO_DATE('1985-10-10', 'YYYY-MM-DD'), 18000000, 4000000, '0905123456', 'GV', 'HOA');

-- Nhân viên cơ bản (NVCB)
INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV) 
VALUES ('NV003', 'Nguyễn Văn B', 'Nam', TO_DATE('1995-02-15', 'YYYY-MM-DD'), 12000000, 2000000, '0901234567', 'NVCB', 'HOA');

INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV) 
VALUES ('NV004', 'Trần Thị C', 'Nữ', TO_DATE('1996-03-20', 'YYYY-MM-DD'), 12500000, 2500000, '0912345678', 'NVCB', 'HOA');

-- Giảng viên (GV)
INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV) 
VALUES ('GV002', 'Lê Văn D', 'Nam', TO_DATE('1988-11-10', 'YYYY-MM-DD'), 22000000, 6000000, '0923456789', 'GV', 'HOA');

INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV) 
VALUES ('GV003', 'Nguyễn Thị E', 'Nữ', TO_DATE('1990-07-25', 'YYYY-MM-DD'), 21000000, 5500000, '0934567890', 'GV', 'HOA');

-- Nhân viên Phòng Đào tạo (NV PĐT)
INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV) 
VALUES ('NV005', 'Phạm Văn F', 'Nam', TO_DATE('1992-05-30', 'YYYY-MM-DD'), 15000000, 3000000, '0945678901', 'NV PĐT', 'PĐT');

INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV) 
VALUES ('NV006', 'Trần Thị G', 'Nữ', TO_DATE('1993-08-18', 'YYYY-MM-DD'), 15500000, 3200000, '0956789012', 'NV PĐT', 'PĐT');

-- Nhân viên Phòng Khảo thí (NV PKT)
INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV) 
VALUES ('NV007', 'Nguyễn Văn H', 'Nam', TO_DATE('1987-12-05', 'YYYY-MM-DD'), 18000000, 4000000, '0967890123', 'NV PKT', 'HOA');

INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV) 
VALUES ('NV008', 'Lê Thị I', 'Nữ', TO_DATE('1991-01-22', 'YYYY-MM-DD'), 17500000, 3800000, '0978901234', 'NV PKT', 'HOA');

-- Nhân viên Phòng Tổ chức hành chính (NV TCHC)
INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV) 
VALUES ('NV009', 'Trần Văn J', 'Nam', TO_DATE('1989-04-14', 'YYYY-MM-DD'), 16000000, 3500000, '0989012345', 'NV TCHC', 'PĐT');

INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV) 
VALUES ('NV010', 'Nguyễn Thị K', 'Nữ', TO_DATE('1994-06-30', 'YYYY-MM-DD'), 16500000, 3600000, '0990123456', 'NV TCHC', 'PĐT');

-- Nhân viên Phòng Công tác sinh viên (NV CTSV)
INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV) 
VALUES ('NV011', 'Phạm Văn L', 'Nam', TO_DATE('1990-09-10', 'YYYY-MM-DD'), 14000000, 2800000, '0901234568', 'NV CTSV', 'PĐT');

INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV) 
VALUES ('NV012', 'Lê Thị M', 'Nữ', TO_DATE('1995-11-20', 'YYYY-MM-DD'), 14500000, 2900000, '0912345679', 'NV CTSV', 'PĐT');

-- Nhân viên Trưởng đơn vị (TRGDV)
INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV) 
VALUES ('NV013', 'Nguyễn Văn N', 'Nam', TO_DATE('1986-03-15', 'YYYY-MM-DD'), 25000000, 7000000, '0923456780', 'TRGDV', 'HOA');

INSERT INTO NHANVIEN (MANV, HOTEN, PHAI, NGSINH, LUONG, PHUCAP, DT, VAITRO, MADV) 
VALUES ('NV014', 'Trần Thị O', 'Nữ', TO_DATE('1985-07-22', 'YYYY-MM-DD'), 24000000, 6500000, '0934567891', 'TRGDV', 'PĐT');

COMMIT;

-- 3. Cập nhật Trưởng đơn vị cho DONVI (Sau khi đã có nhân viên)
UPDATE DONVI SET TRGDV = 'NV001' WHERE MADV = 'HOA';
UPDATE DONVI SET TRGDV = 'NV002' WHERE MADV = 'PĐT';
COMMIT;

-- 4. Chèn dữ liệu vào bảng SINHVIEN
INSERT INTO SINHVIEN (MASV, HOTEN, PHAI, NGSINH, DCHI, DT, KHOA, TINHTRANG) 
VALUES ('SV001', 'Phạm Thị D', 'Nữ', TO_DATE('2002-03-25', 'YYYY-MM-DD'), 'Hà Nội', '0911111111', 'HOA', 'đang học');

INSERT INTO SINHVIEN (MASV, HOTEN, PHAI, NGSINH, DCHI, DT, KHOA, TINHTRANG) 
VALUES ('SV002', 'Hoàng Văn E', 'Nam', TO_DATE('2003-07-12', 'YYYY-MM-DD'), 'TP.HCM', '0922222222', 'HOA', 'đang học');
COMMIT;

-- 5. Chèn dữ liệu vào bảng HOCPHAN
INSERT INTO HOCPHAN (MAHP, TENHP, SOTC, STLT, STTH, MADV) 
VALUES ('HP001', 'Hóa đại cương', 3, 30, 15, 'HOA');

INSERT INTO HOCPHAN (MAHP, TENHP, SOTC, STLT, STTH, MADV) 
VALUES ('HP002', 'Hóa hữu cơ', 4, 45, 20, 'HOA');
COMMIT;

-- 6. Chèn dữ liệu vào bảng MOMON
INSERT INTO MOMON (MAMM, MAHP, MAGV, HK, NAM) 
VALUES ('MM20231', 'HP001', 'GV001', 1, 2023);

INSERT INTO MOMON (MAMM, MAHP, MAGV, HK, NAM) 
VALUES ('MM20232', 'HP002', 'GV001', 2, 2023);
COMMIT;

-- 7. Chèn dữ liệu vào bảng DANGKY
INSERT INTO DANGKY (MASV, MAMM, DIEMTH, DIEMQT, DIEMCK, DIEMTK) 
VALUES ('SV001', 'MM20231', 8.5, 7.0, 9.0, (8.5*0.2 + 7.0*0.3 + 9.0*0.5));

INSERT INTO DANGKY (MASV, MAMM, DIEMTH, DIEMQT, DIEMCK, DIEMTK) 
VALUES ('SV002', 'MM20232', 7.0, 8.5, 8.0, (7.0*0.2 + 8.5*0.3 + 8.0*0.5));
COMMIT;

-- Xác nhận tất cả thay đổi
COMMIT;


